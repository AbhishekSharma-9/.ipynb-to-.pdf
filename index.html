<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jupyter to PDF (Smart Split)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    window.mathJaxReady = true;
                }
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    
    <style>
        /* --- APP BACKGROUND --- */
        body {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: #525659;
            margin: 0;
            padding: 40px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* --- CONTROL PANEL --- */
        .controls {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            text-align: center;
            width: 90%;
            max-width: 500px;
            margin-bottom: 30px;
            z-index: 10;
        }

        .btn {
            background-color: #e67e22;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 15px;
            transition: background 0.2s;
        }
        .btn:hover { background-color: #d35400; }
        .btn:disabled { background-color: #ccc; cursor: wait; }

        /* --- PREVIEW PAGE (A4 Logic) --- */
        #notebook-preview {
            background: white;
            width: 210mm; /* A4 Width */
            min-height: 297mm;
            /* VISUAL MARGINS: Handled by padding. 
               We set PDF margins to 0 Left/Right to respect this exactly. */
            padding: 10mm 15mm; 
            margin: 0 auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            box-sizing: border-box;
            position: relative;
        }

        /* --- CELL STYLING --- */
        .cell { 
            margin-bottom: 15px; 
            width: 100%;
        }

        /* --- ATOMIC BLOCKS (PREVENT SPLITTING) --- */
        /* This class is applied to Input groups, Output rows, and Markdown blocks.
           'page-break-inside: avoid' forces the PDF engine to push the whole block 
           to the next page if it doesn't fit at the bottom. */
        .no-break {
            page-break-inside: avoid;
            break-inside: avoid;
            margin-bottom: 8px;
        }

        /* --- INNER LAYOUT --- */
        .inner_cell { 
            display: flex; 
            flex-direction: row; 
            align-items: flex-start;
        }

        /* --- PROMPTS --- */
        .prompt { 
            font-family: "Menlo", "Consolas", "DejaVu Sans Mono", monospace; 
            font-size: 11px; 
            width: 14mm; 
            text-align: right; 
            padding-right: 3mm; 
            padding-top: 5px; 
            flex-shrink: 0;
            user-select: none;
        }
        .prompt.input { color: #303F9F; font-weight: bold; }
        .prompt.output { color: #D84315; }

        /* --- CONTENT BOXES --- */
        .content_box {
            flex-grow: 1;
            min-width: 0; /* Flexbox overflow fix */
        }

        .input_area { 
            background: #f7f7f7; 
            border: 1px solid #e0e0e0; 
            border-radius: 2px; 
            padding: 8px 10px; 
            width: 100%;
            box-sizing: border-box;
        }

        pre { margin: 0; white-space: pre-wrap; word-wrap: break-word; }
        code { 
            font-family: "Menlo", "Consolas", "DejaVu Sans Mono", monospace; 
            font-size: 12px; 
            line-height: 1.45;
        }

        /* --- OUTPUTS --- */
        .output_wrapper { 
            font-family: "Menlo", "Consolas", monospace;
            font-size: 12px;
            color: #2c2c2c;
            width: 100%;
        }
        
        img { 
            max-width: 100%; 
            height: auto; 
            display: block; 
            margin-top: 5px;
            background-color: white;
        }

        /* --- MARKDOWN --- */
        .rendered_html { 
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 14px; 
            line-height: 1.5; 
            color: #212121;
            padding-left: 17mm; /* Align with Prompt width + padding */
            margin-bottom: 15px;
        }
        
        /* Table Styling */
        .rendered_html table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
            font-size: 13px;
            page-break-inside: avoid;
        }
        .rendered_html th, .rendered_html td {
            border: 1px solid #ddd;
            padding: 6px 8px;
            text-align: left;
        }
        .rendered_html th { background-color: #f2f2f2; font-weight: bold; }
        
        /* MathJax Adjustments */
        mjx-container { font-size: 110% !important; }
    </style>
</head>
<body>

    <div class="controls" data-html2canvas-ignore="true">
        <h2 style="margin:0 0 10px 0; color:#333;">Jupyter to PDF (Smart)</h2>
        <p style="margin:0 0 20px 0; color:#666; font-size:14px;">Perfect alignment. No split cells. No footer overlap.</p>
        
        <input type="file" id="fileInput" accept=".ipynb" style="margin-bottom:10px;" />
        <br>
        <button id="convertBtn" class="btn" disabled>Generate PDF</button>
        <p id="status" style="margin-top:15px; font-size: 13px; color: #555; min-height: 18px;">Waiting for file...</p>
    </div>

    <div id="notebook-preview"></div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const convertBtn = document.getElementById('convertBtn');
        const previewArea = document.getElementById('notebook-preview');
        const status = document.getElementById('status');
        let filename = 'notebook';

        // 1. File Upload Handling
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            filename = file.name.replace('.ipynb', '');
            status.textContent = "Parsing Notebook...";
            convertBtn.disabled = true;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    renderNotebook(data);
                } catch (err) {
                    console.error(err);
                    status.textContent = "Error: Invalid IPYNB file.";
                }
            };
            reader.readAsText(file);
        });

        // 2. Render Logic
        async function renderNotebook(data) {
            previewArea.innerHTML = ''; 
            const cells = data.cells || [];

            for (const cell of cells) {
                const cellDiv = document.createElement('div');
                cellDiv.className = 'cell';

                // --- CODE CELLS ---
                if (cell.cell_type === 'code') {
                    // Input Block -> ATOMIC (no-break)
                    const inputGroup = document.createElement('div');
                    inputGroup.className = 'inner_cell no-break'; 
                    inputGroup.innerHTML = `
                        <div class="prompt input">In [${cell.execution_count || ' '}]:</div>
                        <div class="content_box">
                            <div class="input_area">
                                <pre><code class="language-python">${escapeHtml(joinSource(cell.source))}</code></pre>
                            </div>
                        </div>
                    `;
                    cellDiv.appendChild(inputGroup);

                    // Output Blocks -> ATOMIC (no-break)
                    if (cell.outputs && cell.outputs.length) {
                        cell.outputs.forEach(out => {
                            const outRow = document.createElement('div');
                            outRow.className = 'inner_cell no-break';
                            let outHtml = '';

                            if (out.data && (out.data['image/png'] || out.data['image/jpeg'])) {
                                const mime = out.data['image/png'] ? 'image/png' : 'image/jpeg';
                                const b64 = Array.isArray(out.data[mime]) ? out.data[mime].join('').replace(/\n/g, '') : out.data[mime];
                                outHtml = `<img src="data:${mime};base64,${b64}" />`;
                            } 
                            else if (out.text || (out.data && out.data['text/plain'])) {
                                const txt = out.text || out.data['text/plain'];
                                outHtml = `<pre>${escapeHtml(joinSource(txt))}</pre>`;
                            } 
                            else if (out.data && out.data['text/html']) {
                                outHtml = `<div style="width:100%">${joinSource(out.data['text/html'])}</div>`;
                            }

                            if(outHtml) {
                                const promptText = (out.output_type === 'execute_result') 
                                    ? `Out [${cell.execution_count || ''}]:` 
                                    : ''; 
                                
                                outRow.innerHTML = `
                                    <div class="prompt output">${promptText}</div>
                                    <div class="content_box output_wrapper">${outHtml}</div>
                                `;
                                cellDiv.appendChild(outRow);
                            }
                        });
                    }
                } 
                // --- MARKDOWN CELLS ---
                else if (cell.cell_type === 'markdown') {
                    const mdDiv = document.createElement('div');
                    // Mark markdown as no-break so paragraphs don't split awkwardly
                    mdDiv.className = 'rendered_html no-break';
                    mdDiv.innerHTML = marked.parse(joinSource(cell.source));
                    cellDiv.appendChild(mdDiv);
                }

                previewArea.appendChild(cellDiv);
            }

            document.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));

            if (window.MathJax) {
                status.textContent = "Rendering Math...";
                await MathJax.typesetPromise([previewArea]);
            }

            status.textContent = "Ready to Download.";
            convertBtn.disabled = false;
        }

        // 3. PDF Generation Logic
        convertBtn.addEventListener('click', () => {
            status.textContent = "Generating PDF...";
            convertBtn.disabled = true;

            const opt = {
                // MARGINS: [Top, Left, Bottom, Right]
                // Bottom=15mm creates the "Safe Zone" for the footer.
                // Left/Right=0 ensures our CSS padding handles the width centering correctly.
                margin:       [10, 0, 15, 0], 
                filename:     filename + '.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true, logging: false },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                // 'css' mode respects the 'page-break-inside: avoid' rule we added
                pagebreak:    { mode: 'css', avoid: '.no-break' } 
            };

            html2pdf().from(previewArea).set(opt).toPdf().get('pdf').then((pdf) => {
                const totalPages = pdf.internal.getNumberOfPages();
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                
                for (let i = 1; i <= totalPages; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(8);
                    pdf.setTextColor(120); 
                    
                    const text = "Made by Karlo Sharma | Github Link - https://abhisheksharma-9.github.io/.ipynb-to-.pdf/";
                    
                    // Footer Line (Drawn in the 15mm safe zone)
                    pdf.setDrawColor(200); 
                    pdf.setLineWidth(0.1);
                    pdf.line(15, pageHeight - 12, pageWidth - 15, pageHeight - 12);
                    
                    pdf.text(text, pageWidth / 2, pageHeight - 8, { align: 'center' });
                }
            }).save().then(() => {
                status.textContent = "Download Complete!";
                convertBtn.disabled = false;
            });
        });

        function joinSource(s) { return Array.isArray(s) ? s.join('') : (s || ''); }
        function escapeHtml(t) { return t ? t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ''; }
    </script>
</body>
</html>
