<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPYNB to PDF Converter</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    
    <style>
        body {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            text-align: center;
            width: 100%;
            max-width: 600px;
            margin-bottom: 20px;
            z-index: 100;
        }

        .btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-blue { background-color: #007bff; }

        /* The Printable Area (A4 Paper Visual) */
        #notebook-preview {
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            box-sizing: border-box;
            margin-bottom: 50px;
        }

        /* Jupyter Styling */
        .cell { margin-bottom: 15px; width: 100%; word-wrap: break-word; }
        .input_area { background: #f7f7f7; border: 1px solid #cfcfcf; padding: 5px; border-radius: 2px; }
        .prompt { 
            color: #303F9F; font-family: monospace; font-size: 13px; 
            width: 60px; text-align: right; padding-right: 10px; flex-shrink: 0;
        }
        .inner_cell { display: flex; flex-direction: row; }
        .content_box { width: 100%; overflow-x: hidden; }
        
        pre { margin: 0; white-space: pre-wrap; word-break: break-all; }
        img { max-width: 100%; height: auto; display: block; margin: 10px 0; }

        /* Footer */
        .custom-footer {
            margin-top: 40px;
            padding-top: 15px;
            border-top: 2px solid #333;
            text-align: center;
            font-size: 12px;
            color: #555;
            background-color: #f9f9f9;
            padding-bottom: 10px;
        }
    </style>
</head>
<body>

    <div class="controls">
        <h2>IPYNB to PDF Converter</h2>
        <input type="file" id="fileInput" accept=".ipynb" />
        <br><br>
        <button id="convertBtn" class="btn btn-blue" disabled>Download PDF</button>
        <p id="status" style="margin-top:10px; font-size: 14px; color: #555;">Select a file to preview...</p>
    </div>

    <div id="notebook-preview"></div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const convertBtn = document.getElementById('convertBtn');
        const previewArea = document.getElementById('notebook-preview');
        const status = document.getElementById('status');
        let filename = 'notebook';

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            filename = file.name.replace('.ipynb', '');
            status.textContent = "Parsing file...";
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    renderNotebook(data);
                    status.textContent = "Preview loaded below. Click Download PDF to save.";
                    convertBtn.disabled = false;
                } catch (err) {
                    console.error(err);
                    status.textContent = "Error: Invalid IPYNB file.";
                }
            };
            reader.readAsText(file);
        });

        convertBtn.addEventListener('click', () => {
            status.textContent = "Generating PDF... Please wait (this may take a few seconds).";
            
            const opt = {
                margin:       0, // Margins handled by CSS padding
                filename:     filename + '.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true, scrollY: 0 },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // We select the PREVIEW element directly
            html2pdf().set(opt).from(previewArea).save().then(() => {
                status.textContent = "PDF Downloaded!";
            }).catch(err => {
                status.textContent = "Error generating PDF: " + err.message;
            });
        });

        function renderNotebook(data) {
            previewArea.innerHTML = ''; 
            
            // Check for Cells
            const cells = data.cells || [];
            if(cells.length === 0) {
                previewArea.innerHTML = '<p style="text-align:center">This notebook appears to be empty.</p>';
                return;
            }

            cells.forEach(cell => {
                const cellDiv = document.createElement('div');
                cellDiv.className = 'cell';

                // --- CODE CELLS ---
                if (cell.cell_type === 'code') {
                    // Input
                    const inputRow = document.createElement('div');
                    inputRow.className = 'inner_cell';
                    inputRow.innerHTML = `
                        <div class="prompt">In [${cell.execution_count || ' '}]:</div>
                        <div class="content_box input_area">
                            <pre><code class="language-python">${escapeHtml(joinSource(cell.source))}</code></pre>
                        </div>
                    `;
                    cellDiv.appendChild(inputRow);

                    // Outputs
                    if (cell.outputs && cell.outputs.length) {
                        cell.outputs.forEach(out => {
                            const outRow = document.createElement('div');
                            outRow.className = 'inner_cell';
                            
                            let outHtml = '';
                            
                            // 1. Images (Base64)
                            if (out.data && (out.data['image/png'] || out.data['image/jpeg'])) {
                                const mime = out.data['image/png'] ? 'image/png' : 'image/jpeg';
                                const b64 = Array.isArray(out.data[mime]) ? out.data[mime].join('').replace(/\n/g, '') : out.data[mime];
                                outHtml = `<img src="data:${mime};base64,${b64}" />`;
                            } 
                            // 2. Text/Plain
                            else if (out.text || (out.data && out.data['text/plain'])) {
                                const txt = out.text || out.data['text/plain'];
                                outHtml = `<pre>${escapeHtml(joinSource(txt))}</pre>`;
                            }
                            // 3. HTML (Simple render)
                            else if (out.data && out.data['text/html']) {
                                outHtml = `<div class="rendered_html">${joinSource(out.data['text/html'])}</div>`;
                            }

                            outRow.innerHTML = `
                                <div class="prompt">Out[${out.execution_count || ''}]:</div>
                                <div class="content_box">${outHtml}</div>
                            `;
                            cellDiv.appendChild(outRow);
                        });
                    }
                } 
                // --- MARKDOWN CELLS ---
                else if (cell.cell_type === 'markdown') {
                    const mdRow = document.createElement('div');
                    mdRow.className = 'inner_cell';
                    const rawMd = joinSource(cell.source);
                    mdRow.innerHTML = `
                        <div class="prompt"></div>
                        <div class="content_box rendered_html">${marked.parse(rawMd)}</div>
                    `;
                    cellDiv.appendChild(mdRow);
                }

                previewArea.appendChild(cellDiv);
            });

            // Highlight Code
            document.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));

            // Custom Footer
            const footer = document.createElement('div');
            footer.className = 'custom-footer';
            footer.innerHTML = `
                <span>Made by Karlo Sharma | Github Link - </span>
                <a href="https://abhisheksharma-9.github.io/.ipynb-to-.pdf/" style="color:#007bff; text-decoration:none;">https://abhisheksharma-9.github.io/.ipynb-to-.pdf/</a>
            `;
            previewArea.appendChild(footer);
        }

        // Helpers
        function joinSource(s) {
            if (Array.isArray(s)) return s.join('');
            return s ? s : '';
        }
        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
