<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPYNB to PDF Converter</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    
    <style>
        body {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            text-align: center;
            width: 100%;
            max-width: 600px;
            margin-bottom: 20px;
        }

        .btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-blue { background-color: #007bff; }

        /* PREVIEW AREA */
        #notebook-preview {
            background: white;
            width: 210mm; /* A4 Width */
            min-height: 297mm;
            padding: 20mm;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            box-sizing: border-box;
        }

        /* --- SMART PAGE BREAKS --- */
        .cell { 
            margin-bottom: 20px; 
            width: 100%; 
            /* This forces the PDF engine to NOT cut this element in half */
            page-break-inside: avoid; 
        }

        /* JUPYTER STYLING */
        .input_area { background: #f7f7f7; border: 1px solid #cfcfcf; padding: 10px; border-radius: 4px; }
        .prompt { 
            color: #303F9F; font-family: monospace; font-size: 13px; 
            width: 60px; text-align: right; padding-right: 10px; flex-shrink: 0;
            user-select: none;
        }
        .inner_cell { display: flex; flex-direction: row; margin-bottom: 5px; }
        .content_box { width: 100%; overflow-x: hidden; }
        
        pre { margin: 0; white-space: pre-wrap; word-break: break-all; font-family: monospace; font-size: 13px; }
        img { max-width: 100%; height: auto; display: block; margin: 10px 0; }
        
        .rendered_html { font-size: 14px; line-height: 1.5; }
        .rendered_html h1, .rendered_html h2, .rendered_html h3 { margin-top: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="controls" data-html2canvas-ignore="true">
        <h2>IPYNB to PDF Converter</h2>
        <input type="file" id="fileInput" accept=".ipynb" />
        <br><br>
        <button id="convertBtn" class="btn btn-blue" disabled>Download PDF</button>
        <p id="status" style="margin-top:10px; font-size: 14px; color: #555;">Select a file to preview...</p>
    </div>

    <div id="notebook-preview"></div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const convertBtn = document.getElementById('convertBtn');
        const previewArea = document.getElementById('notebook-preview');
        const status = document.getElementById('status');
        let filename = 'notebook';

        // 1. Load File
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            filename = file.name.replace('.ipynb', '');
            status.textContent = "Parsing file...";
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    renderNotebook(data);
                    status.textContent = "Preview loaded. Click Download PDF.";
                    convertBtn.disabled = false;
                } catch (err) {
                    console.error(err);
                    status.textContent = "Error: Invalid IPYNB file.";
                }
            };
            reader.readAsText(file);
        });

        // 2. Generate PDF with Footer on Every Page
        convertBtn.addEventListener('click', () => {
            status.textContent = "Generating PDF... (This may take a moment)";
            
            const opt = {
                margin:       [10, 10, 15, 10], // Top, Left, Bottom (extra space for footer), Right
                filename:     filename + '.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                // "avoid-all" tries to not cut images/divs in half
                pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] } 
            };

            // We chain the command to access the internal PDF object
            html2pdf().from(previewArea).set(opt).toPdf().get('pdf').then((pdf) => {
                // Get total pages
                const totalPages = pdf.internal.getNumberOfPages();
                
                // Loop through each page and add the footer
                for (let i = 1; i <= totalPages; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(9);
                    pdf.setTextColor(100);
                    
                    const footerText = "Made by Karlo Sharma | Github Link - https://abhisheksharma-9.github.io/.ipynb-to-.pdf/";
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    
                    // Add text at bottom center
                    pdf.text(footerText, pageWidth / 2, pageHeight - 8, { align: 'center' });
                    
                    // Optional: Add a line above footer
                    pdf.setDrawColor(200);
                    pdf.line(10, pageHeight - 12, pageWidth - 10, pageHeight - 12);
                }
            }).save().then(() => {
                status.textContent = "PDF Downloaded!";
            });
        });

        // 3. Render Notebook Logic (Same as before)
        function renderNotebook(data) {
            previewArea.innerHTML = ''; 
            const cells = data.cells || [];

            cells.forEach(cell => {
                const cellDiv = document.createElement('div');
                cellDiv.className = 'cell'; // This class has 'page-break-inside: avoid'

                if (cell.cell_type === 'code') {
                    // Input
                    const inputRow = document.createElement('div');
                    inputRow.className = 'inner_cell';
                    inputRow.innerHTML = `
                        <div class="prompt">In [${cell.execution_count || ' '}]:</div>
                        <div class="content_box input_area">
                            <pre><code class="language-python">${escapeHtml(joinSource(cell.source))}</code></pre>
                        </div>
                    `;
                    cellDiv.appendChild(inputRow);

                    // Outputs
                    if (cell.outputs && cell.outputs.length) {
                        cell.outputs.forEach(out => {
                            const outRow = document.createElement('div');
                            outRow.className = 'inner_cell';
                            let outHtml = '';

                            if (out.data && (out.data['image/png'] || out.data['image/jpeg'])) {
                                const mime = out.data['image/png'] ? 'image/png' : 'image/jpeg';
                                const b64 = Array.isArray(out.data[mime]) ? out.data[mime].join('').replace(/\n/g, '') : out.data[mime];
                                outHtml = `<img src="data:${mime};base64,${b64}" />`;
                            } else if (out.text || (out.data && out.data['text/plain'])) {
                                const txt = out.text || out.data['text/plain'];
                                outHtml = `<pre>${escapeHtml(joinSource(txt))}</pre>`;
                            } else if (out.data && out.data['text/html']) {
                                outHtml = `<div class="rendered_html">${joinSource(out.data['text/html'])}</div>`;
                            }

                            outRow.innerHTML = `
                                <div class="prompt">Out[${out.execution_count || ''}]:</div>
                                <div class="content_box">${outHtml}</div>
                            `;
                            cellDiv.appendChild(outRow);
                        });
                    }
                } else if (cell.cell_type === 'markdown') {
                    const mdRow = document.createElement('div');
                    mdRow.className = 'inner_cell';
                    mdRow.innerHTML = `
                        <div class="prompt"></div>
                        <div class="content_box rendered_html">${marked.parse(joinSource(cell.source))}</div>
                    `;
                    cellDiv.appendChild(mdRow);
                }
                previewArea.appendChild(cellDiv);
            });
            document.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
        }

        function joinSource(s) { return Array.isArray(s) ? s.join('') : (s || ''); }
        function escapeHtml(t) { return t ? t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ''; }
    </script>
</body>
</html>
